<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ajax upload form</title>
</head>
<body>

<p id="support-notice">Your browser does not support Ajax uploads :-(<br/>The form will be submitted as normal.</p>

<form action="/" method="post" enctype="multipart/form-data" id="form-id">
  <p><input id="file-id" type="file" name="our-file" /> <input type="button" value="Upload" id="upload-button-id" disabled="disabled" /></p>
  <p><label>Some other field: <input name="other-field" type="text" id="other-field-id" /></label></p>
  <p><input type="submit" value="Submit" /></p>
  <script>
function supportAjaxUploadWithProgress() {
  return supportFileAPI() && supportAjaxUploadProgressEvents() && supportFormData();

  function supportFileAPI() {
    var fi = document.createElement('INPUT');
    fi.type = 'file';
    return 'files' in fi;
  };

  function supportAjaxUploadProgressEvents() {
    var xhr = new XMLHttpRequest();
    return !! (xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));
  };

  function supportFormData() {
    return !! window.FormData;
  }
}

if (supportAjaxUploadWithProgress()) {
  var notice = document.getElementById('support-notice');
  var uploadBtn = document.getElementById('upload-button-id');
  notice.innerHTML = "Your browser supports HTML uploads. Go try me! :-)";
  uploadBtn.removeAttribute('disabled');

  initFullFormAjaxUpload();
  initFileOnlyAjaxUpload();
}

function initFullFormAjaxUpload() {
  var form = document.getElementById('form-id');
  form.onsubmit = function() {
    var formData = new FormData(form);
    var action = form.getAttribute('action');

    sendXHRequest(formData, action);

    return false;
  }
}

function initFileOnlyAjaxUpload() {
  var uploadBtn = document.getElementById('upload-button-id');
  uploadBtn.onclick = function (evt) {
    var formData = new FormData();
    var action = '/upload';
    var fileInput = document.getElementById('file-id');
    var file = fileInput.files[0];
    formData.append('our-file', file);

    sendXHRequest(formData, action);

    return false;
  }
}

function sendXHRequest(formData, uri) {
  var xhr = new XMLHttpRequest();
  xhr.upload.addEventListener('loadstart', onloadstartHandler, false);
  xhr.upload.addEventListener('progress', onprogressHandler, false);
  xhr.upload.addEventListener('load', onloadHandler, false);
  xhr.addEventListener('readystatechange', onreadystatechangeHandler, false);
  xhr.open('POST', uri, true);
  xhr.send(formData);
}

function onloadstartHandler(evt) {
  var div = document.getElementById('upload-status');
  div.innerHTML = 'Upload started!';
}

function onloadHandler(evt) {
  var div = document.getElementById('upload-status');
  div.innerHTML = 'Upload successful!';
}

function onprogressHandler(evt) {
  var div = document.getElementById('progress');
  var percent = evt.loaded/evt.total*100;
  div.innerHTML = 'Progress: ' + percent + '%';
}
  
function onreadystatechangeHandler(evt) {
  var status = null;

  try {
    status = evt.target.status;
  }
  catch(e) {
    return;
  }

  if (status == '200' && evt.target.responseText) {
    var result = document.getElementById('result');
    result.innerHTML = '<p>The server saw it as:</p><pre>' + evt.target.responseText + '</pre>';
  }
}
  </script>
  <p id="upload-status"></p>
  <p id="progress"></p>
  <pre id="result"></pre>
</form>
</body>
</html>
